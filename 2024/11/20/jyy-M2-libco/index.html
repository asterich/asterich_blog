<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"asterich.top","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="å—å¤§çš„ OS Lab è¿˜æŒºæœ‰æ„æ€çš„ï¼Œè¿™ä¸ª M2 æ˜¯ç”¨ C è¯­è¨€å†™ä¸€ä¸ªå°çš„æœ‰æ ˆåç¨‹åº“ï¼Œè™½ç„¶æ¯”ä¸ä¸Šå·¥ä¸šçº§åç¨‹åº“ï¼Œä½†ä¹Ÿæ˜¯åŠ æ·±äº†å¯¹ä¸å°‘ä¸œè¥¿çš„è®¤è¯†ï¼Œæ“å‡ºæ¥è¿˜æ˜¯æ¯”è¾ƒæœ‰æˆå°±æ„Ÿçš„ã€‚å›å¤´å†è®²ä¸€ä¸‹æœ‰æ ˆ&#x2F;æ— æ ˆåç¨‹å’Œåç¨‹æ€ä¹ˆç”¨ç½¢ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="NJU OS Lab M2: libco">
<meta property="og:url" content="https://asterich.top/2024/11/20/jyy-M2-libco/index.html">
<meta property="og:site_name" content="asterich&#39;s blog">
<meta property="og:description" content="å—å¤§çš„ OS Lab è¿˜æŒºæœ‰æ„æ€çš„ï¼Œè¿™ä¸ª M2 æ˜¯ç”¨ C è¯­è¨€å†™ä¸€ä¸ªå°çš„æœ‰æ ˆåç¨‹åº“ï¼Œè™½ç„¶æ¯”ä¸ä¸Šå·¥ä¸šçº§åç¨‹åº“ï¼Œä½†ä¹Ÿæ˜¯åŠ æ·±äº†å¯¹ä¸å°‘ä¸œè¥¿çš„è®¤è¯†ï¼Œæ“å‡ºæ¥è¿˜æ˜¯æ¯”è¾ƒæœ‰æˆå°±æ„Ÿçš„ã€‚å›å¤´å†è®²ä¸€ä¸‹æœ‰æ ˆ&#x2F;æ— æ ˆåç¨‹å’Œåç¨‹æ€ä¹ˆç”¨ç½¢ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://asterich.top/2024/11/20/jyy-M2-libco/segfault.png">
<meta property="og:image" content="https://asterich.top/2024/11/20/jyy-M2-libco/segfault2.png">
<meta property="og:image" content="https://asterich.top/2024/11/20/jyy-M2-libco/before_ret.png">
<meta property="og:image" content="https://asterich.top/2024/11/20/jyy-M2-libco/after_ret.png">
<meta property="og:image" content="https://asterich.top/2024/11/20/jyy-M2-libco/exec_co.png">
<meta property="article:published_time" content="2024-11-20T15:36:11.000Z">
<meta property="article:modified_time" content="2024-11-20T19:11:58.326Z">
<meta property="article:author" content="asterich">
<meta property="article:tag" content="C">
<meta property="article:tag" content="Assembly">
<meta property="article:tag" content="sys">
<meta property="article:tag" content="Coroutine">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://asterich.top/2024/11/20/jyy-M2-libco/segfault.png">


<link rel="canonical" href="https://asterich.top/2024/11/20/jyy-M2-libco/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://asterich.top/2024/11/20/jyy-M2-libco/","path":"/2024/11/20/jyy-M2-libco/","title":"NJU OS Lab M2: libco"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>NJU OS Lab M2: libco | asterich's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">asterich's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%8D%8F%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">ä»€ä¹ˆæ˜¯åç¨‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lab-%E4%BB%BB%E5%8A%A1"><span class="nav-number">2.</span> <span class="nav-text">lab ä»»åŠ¡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.</span> <span class="nav-text">å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.1.</span> <span class="nav-text">æ•°æ®ç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%B5%E5%85%A5%E5%BC%8F%E9%93%BE%E8%A1%A8"><span class="nav-number">3.1.1.</span> <span class="nav-text">ä¾µå…¥å¼é“¾è¡¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#struct-co"><span class="nav-number">3.1.2.</span> <span class="nav-text">struct co</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%88%86%E9%85%8D%E4%B8%8E%E9%87%8A%E6%94%BE"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">åç¨‹çš„åˆ†é…ä¸é‡Šæ”¾</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A8%8B%E5%BA%8F%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E6%B8%85%E7%90%86"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">ç¨‹åºåˆå§‹åŒ–å’Œæ¸…ç†</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#co_start"><span class="nav-number">3.2.</span> <span class="nav-text">co_start()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#co_wait"><span class="nav-number">3.3.</span> <span class="nav-text">co_wait()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#co_yield"><span class="nav-number">3.4.</span> <span class="nav-text">co_yield()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%89%E5%8D%8F%E7%A8%8B"><span class="nav-number">3.4.1.</span> <span class="nav-text">é€‰åç¨‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8D%A2%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="nav-number">3.4.2.</span> <span class="nav-text">æ¢ä¸Šä¸‹æ–‡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9C%9F%E7%9A%84%E5%81%87%E7%9A%84"><span class="nav-number">3.4.3.</span> <span class="nav-text">çœŸçš„å‡çš„ï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#stack_switch_call"><span class="nav-number">3.4.4.</span> <span class="nav-text">stack_switch_call()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E5%B0%8F%E9%97%AE%E9%A2%98"><span class="nav-number">3.4.5.</span> <span class="nav-text">ä¸€äº›å°é—®é¢˜</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">asterich</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/asterich" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;asterich" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          é“¾æ¥
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://stellarlane.github.io/" title="https:&#x2F;&#x2F;stellarlane.github.io" rel="noopener" target="_blank">https://stellarlane.github.io</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://asterich.top/2024/11/20/jyy-M2-libco/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="asterich">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="asterich's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="NJU OS Lab M2: libco | asterich's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          NJU OS Lab M2: libco
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2024-11-20 23:36:11" itemprop="dateCreated datePublished" datetime="2024-11-20T23:36:11+08:00">2024-11-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-11-21 03:11:58" itemprop="dateModified" datetime="2024-11-21T03:11:58+08:00">2024-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">ç¼–ç¨‹</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>å—å¤§çš„ OS Lab è¿˜æŒºæœ‰æ„æ€çš„ï¼Œè¿™ä¸ª M2 æ˜¯ç”¨ C è¯­è¨€å†™ä¸€ä¸ªå°çš„æœ‰æ ˆåç¨‹åº“ï¼Œè™½ç„¶æ¯”ä¸ä¸Šå·¥ä¸šçº§åç¨‹åº“ï¼Œä½†ä¹Ÿæ˜¯åŠ æ·±äº†å¯¹ä¸å°‘ä¸œè¥¿çš„è®¤è¯†ï¼Œæ“å‡ºæ¥è¿˜æ˜¯æ¯”è¾ƒæœ‰æˆå°±æ„Ÿçš„ã€‚å›å¤´å†è®²ä¸€ä¸‹æœ‰æ ˆ/æ— æ ˆåç¨‹å’Œåç¨‹æ€ä¹ˆç”¨ç½¢ã€‚</p>
<span id="more"></span>
<h2 id="ä»€ä¹ˆæ˜¯åç¨‹">ä»€ä¹ˆæ˜¯åç¨‹</h2>
<p>åç¨‹ï¼Œæœ€ç®€å•ç²—æš´çš„ç†è§£å°±æ˜¯â€œå¯ä»¥æŒ‚èµ·/æ¢å¤æ‰§è¡Œçš„å‡½æ•°â€ã€‚è¿™è·Ÿå¹¶è¡Œå®é™…ä¸Šæ²¡å•¥å…³ç³»ï¼Œå€’æ˜¯æ›´åƒä¸­æ–­ä¹‹ç±»çš„ã€‚å®ƒèƒ½å¤Ÿå®Œå…¨åœ¨ç”¨æˆ·æ€ä¸‹å®ç°å¹¶å‘ï¼Œè€Œä¸”ä¹Ÿæ¯”æ“ä½œç³»ç»Ÿæä¾›çš„çº¿ç¨‹è®¾æ–½è½»å¾ˆå¤šï¼Œæœ€é€‚åˆä¸€äº›éœ€è¦é«˜ IO é«˜å¹¶å‘çš„åœºæ™¯ï¼›å½“ç„¶åç¨‹ä¹Ÿå¯ä»¥ç”¨æ¥åšç”Ÿæˆå™¨ä¹‹ç±»çš„ã€‚</p>
<p>æœ‰æ ˆåç¨‹å’Œæ— æ ˆåç¨‹æ˜¯åç¨‹ä¸¤ç§ä¸åŒçš„å®ç°æ–¹å¼ï¼Œè¿™é‡Œä¸ç»†è®²ï¼Œåªè¦çŸ¥é“æœ‰æ ˆåç¨‹ä¸‹åç¨‹è‡ªæœ‰æ ˆç©ºé—´å³å¯ã€‚</p>
<h2 id="lab-ä»»åŠ¡">lab ä»»åŠ¡</h2>
<p>ç‰¢è’‹ç»™äº† 3 ä¸ªå‡½æ•°ä½œä¸ºåç¨‹åº“çš„ APIï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> co* <span class="title function_">co_start</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">void</span> (*func)(<span class="type">void</span> *), <span class="type">void</span> *arg)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">co_yield</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">co_wait</span><span class="params">(<span class="keyword">struct</span> co *co)</span>;</span><br></pre></td></tr></table></figure>
<p>å¼•ç”¨ä¸‹ä»–çš„è¦æ±‚<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>ï¼š</p>
<blockquote>
<p>co_start(name, func, arg) åˆ›å»ºä¸€ä¸ªæ–°çš„åç¨‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘ struct co çš„æŒ‡é’ˆ (ç±»ä¼¼äº pthread_create)ã€‚</p>
<blockquote>
<p>æ–°åˆ›å»ºçš„åç¨‹ä»å‡½æ•° func å¼€å§‹æ‰§è¡Œï¼Œå¹¶ä¼ å…¥å‚æ•° argã€‚æ–°åˆ›å»ºçš„åç¨‹ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è°ƒç”¨ co_start çš„åç¨‹ç»§ç»­æ‰§è¡Œã€‚</p>
<p>ä½¿ç”¨åç¨‹çš„åº”ç”¨ç¨‹åºä¸éœ€è¦çŸ¥é“ struct co çš„å…·ä½“å®šä¹‰ï¼Œå› æ­¤è¯·æŠŠè¿™ä¸ªå®šä¹‰ç•™åœ¨ co.c ä¸­ï¼›æ¡†æ¶ä»£ç ä¸­å¹¶æ²¡æœ‰é™å®š struct co ç»“æ„ä½“çš„è®¾è®¡ï¼Œæ‰€ä»¥ä½ å¯ä»¥è‡ªç”±å‘æŒ¥ã€‚</p>
<p>co_start è¿”å›çš„ struct co æŒ‡é’ˆéœ€è¦åˆ†é…å†…å­˜ã€‚æˆ‘ä»¬æ¨èä½¿ç”¨ malloc() åˆ†é…ã€‚</p>
</blockquote>
<p>co_wait(co) è¡¨ç¤ºå½“å‰åç¨‹éœ€è¦ç­‰å¾…ï¼Œç›´åˆ° co åç¨‹çš„æ‰§è¡Œå®Œæˆæ‰èƒ½ç»§ç»­æ‰§è¡Œ (ç±»ä¼¼äº pthread_join)ã€‚</p>
<blockquote>
<p>åœ¨è¢«ç­‰å¾…çš„åç¨‹ç»“æŸåã€ co_wait() è¿”å›å‰ï¼Œco_start åˆ†é…çš„ struct co éœ€è¦è¢«é‡Šæ”¾ã€‚å¦‚æœä½ ä½¿ç”¨ malloc()ï¼Œä½¿ç”¨ free() é‡Šæ”¾å³å¯ã€‚</p>
<p>å› æ­¤ï¼Œæ¯ä¸ªåç¨‹åªèƒ½è¢« co_wait ä¸€æ¬¡ (ä½¿ç”¨åç¨‹åº“çš„ç¨‹åºåº”å½“ä¿è¯é™¤äº†åˆå§‹åç¨‹å¤–ï¼Œå…¶ä»–åç¨‹éƒ½å¿…é¡»è¢« co_wait æ°å¥½ä¸€æ¬¡ï¼Œå¦åˆ™ä¼šé€ æˆå†…å­˜æ³„æ¼)ã€‚</p>
</blockquote>
<p>co_yield() å®ç°åç¨‹çš„åˆ‡æ¢ã€‚åç¨‹è¿è¡Œåä¸€ç›´åœ¨ CPU ä¸Šæ‰§è¡Œï¼Œç›´åˆ° func å‡½æ•°è¿”å›æˆ–è°ƒç”¨ co_yield ä½¿å½“å‰è¿è¡Œçš„åç¨‹æš‚æ—¶æ”¾å¼ƒæ‰§è¡Œã€‚co_yield æ—¶è‹¥ç³»ç»Ÿä¸­æœ‰å¤šä¸ªå¯è¿è¡Œçš„åç¨‹æ—¶ (åŒ…æ‹¬å½“å‰åç¨‹)ï¼Œä½ åº”å½“éšæœºé€‰æ‹©ä¸‹ä¸€ä¸ªç³»ç»Ÿä¸­å¯è¿è¡Œçš„åç¨‹ã€‚</p>
</blockquote>
<p>è¿˜æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„ï¼š</p>
<blockquote>
<p>main å‡½æ•°çš„æ‰§è¡Œä¹Ÿæ˜¯ä¸€ä¸ªåç¨‹ï¼Œå› æ­¤å¯ä»¥åœ¨ main ä¸­è°ƒç”¨ co_yield æˆ– co_waitã€‚main å‡½æ•°è¿”å›åï¼Œæ— è®ºæœ‰å¤šå°‘åç¨‹ï¼Œè¿›ç¨‹éƒ½å°†ç›´æ¥ç»ˆæ­¢ã€‚</p>
</blockquote>
<h2 id="å®ç°">å®ç°</h2>
<p>ç‰¢è’‹å·²ç»åœ¨å®éªŒç½‘ç«™ä¸Šç»™äº†å¾ˆå¤šæœ‰ç”¨çš„ä¿¡æ¯ï¼Œéå¸¸çš„å®å®å·´å£«ï¼Œä½ å¾€ä¸‹çœ‹å°±èƒ½ä½“ä¼šåˆ°äº†ã€‚</p>
<h3 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h3>
<h4 id="ä¾µå…¥å¼é“¾è¡¨">ä¾µå…¥å¼é“¾è¡¨</h4>
<p>è¿™ä¸ªä¸å¤šè¯´ï¼Œçœ‹çœ‹å®šä¹‰å’Œåˆå§‹åŒ–å°±è¡Œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; <span class="type">list_head_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">list_init</span><span class="params">(<span class="type">list_head_t</span> *head)</span> &#123; head-&gt;next = head; &#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä½œä¸ºåç¨‹çš„é“¾è¡¨å¤´ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">list_head_t</span> coroutine_list;</span><br></pre></td></tr></table></figure>
<h4 id="struct-co"><code>struct co</code></h4>
<p>æœ€é‡è¦çš„æ•°æ®ç»“æ„å°±æ˜¯æˆ‘ä»¬äº²çˆ±çš„ <code>struct co</code>ã€‚ç”±äºæˆ‘ä»¬è¦æ‰‹æ“çš„äº‹æœ‰æ ˆåç¨‹ï¼Œåç¨‹é‡Œé¢èµ·ç åº”è¯¥æœ‰ï¼š</p>
<ul>
<li>å…¥å£åœ°å€å’Œå‚æ•°</li>
<li>åç¨‹çŠ¶æ€</li>
<li>ä¸Šä¸‹æ–‡</li>
<li>åç¨‹è‡ªå·±çš„æ ˆç©ºé—´</li>
</ul>
<p>ä¸‡å¹¸çš„æ˜¯ç‰¢è’‹å·²ç»ç»™äº†ä¸ªå‚è€ƒå®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">co_status</span> &#123;</span></span><br><span class="line">  CO_NEW = <span class="number">1</span>,  <span class="comment">// æ–°åˆ›å»ºï¼Œè¿˜æœªæ‰§è¡Œè¿‡</span></span><br><span class="line">  CO_RUNNABLE, <span class="comment">// å·²ç»æ‰§è¡Œè¿‡ï¼Œyieldäº†</span></span><br><span class="line">  CO_WAITING,  <span class="comment">// åœ¨ co_wait ä¸Šç­‰å¾…</span></span><br><span class="line">  CO_DEAD,     <span class="comment">// å·²ç»ç»“æŸï¼Œä½†è¿˜æœªé‡Šæ”¾èµ„æº</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">co</span> &#123;</span></span><br><span class="line">  <span class="type">char</span> *name;</span><br><span class="line">  <span class="type">void</span> (*func)(<span class="type">void</span> *); <span class="comment">// co_start æŒ‡å®šçš„å…¥å£åœ°å€å’Œå‚æ•°</span></span><br><span class="line">  <span class="type">void</span> *arg;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">co_status</span> <span class="title">status</span>;</span>     <span class="comment">// åç¨‹çš„çŠ¶æ€</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">co</span> *<span class="title">waiter</span>;</span>         <span class="comment">// æ˜¯å¦æœ‰å…¶ä»–åç¨‹åœ¨ç­‰å¾…å½“å‰åç¨‹</span></span><br><span class="line">  jmp_buf context;           <span class="comment">// å¯„å­˜å™¨ç°åœº (setjmp.h)</span></span><br><span class="line">  __attribute__((aligned(<span class="number">16</span>))) <span class="type">uint8_t</span> <span class="built_in">stack</span>[STACK_SIZE]; <span class="comment">// åç¨‹çš„å †æ ˆ</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ª waiter æœ‰å¯èƒ½å¯ä»¥å»æ‰ï¼Œä¸è¿‡ç›®å‰æˆ‘çš„å®ç°ä¸­è¿˜æ˜¯ä¼šä¾èµ–å®ƒã€‚å¦‚æœæƒ³è¦ä¸€ä¸ªè¿”å›å€¼çš„è¯ä¼¼ä¹ä¹Ÿå¾—ç•™ç€ï¼ˆï¼Ÿï¼‰</p>
<p>ç”±äºæˆ‘æ‰“ç®—ç”¨ä¾µå…¥å¼é“¾è¡¨æ¥ç»„ç»‡ <code>struct co</code>ï¼Œè¿™ä¸ªç»“æ„ä½“é‡Œé¢è¿˜å¾—åŠ å…¥é“¾è¡¨èŠ‚ç‚¹ï¼›åé¢ä¼šå‘ç°å¦‚æœä¸åš LRU çš„è¯ä¼šæœ‰åç¨‹é¥¥é¥¿çš„é—®é¢˜ï¼Œæœ¬ğŸ­åˆä¸æƒ³çœŸçš„å†™ä¸€ä¸ª LRU é˜Ÿåˆ—ï¼Œäºæ˜¯å·æ‡’åŠ äº†ä¸€ä¸ª <code>call_cnt</code>, è¡¨ç¤ºç›®å‰ä¸ºæ­¢è¢«è°ƒåº¦åˆ°çš„æ¬¡æ•°ã€‚</p>
<blockquote>
<p>è¿™æ ·çš„å®ç°ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ <code>call_cnt</code> æº¢å‡ºä½ å°±å®Œè›‹äº†ï¼</p>
</blockquote>
<p>äºæ˜¯æœ€åçš„ <code>struct co</code> å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">co</span> &#123;</span></span><br><span class="line">  <span class="type">char</span> *name;</span><br><span class="line">  <span class="type">void</span> (*func)(<span class="type">void</span> *); <span class="comment">// co_start æŒ‡å®šçš„å…¥å£åœ°å€å’Œå‚æ•°</span></span><br><span class="line">  <span class="type">void</span> *arg;</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> call_cnt;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">co_status</span> <span class="title">status</span>;</span>     <span class="comment">// åç¨‹çš„çŠ¶æ€</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">co</span> *<span class="title">waiter</span>;</span>         <span class="comment">// æ˜¯å¦æœ‰å…¶ä»–åç¨‹åœ¨ç­‰å¾…å½“å‰åç¨‹</span></span><br><span class="line">  jmp_buf context;           <span class="comment">// å¯„å­˜å™¨ç°åœº (setjmp.h)</span></span><br><span class="line">  __attribute__((aligned(<span class="number">16</span>))) <span class="type">uint8_t</span> <span class="built_in">stack</span>[STACK_SIZE]; <span class="comment">// åç¨‹çš„å †æ ˆ</span></span><br><span class="line"></span><br><span class="line">  <span class="type">list_head_t</span> co_list;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆå‡­ç©ºå¤šå‡ºæ¥ä¸€ä¸ª <code>__attribute__((aligned(16)))</code> ï¼Ÿè¿™æ˜¯å› ä¸º x86_64 çš„è°ƒç”¨è§„å®šéœ€è¦ä½ åœ¨æ‰§è¡Œ <code>call</code> æŒ‡ä»¤æ—¶ï¼Œ rsp æ˜¯ 16 å­—èŠ‚å¯¹é½çš„ï¼› x86_32 åˆ™æ˜¯è¦æ±‚ 8 å­—èŠ‚å¯¹é½ã€‚åé¢ä¹Ÿä¼šæåˆ°è¿™ç‚¹ã€‚<del>æ­¤äº‹åœ¨å®éªŒç½‘ç«™ä¸Šäº¦æœ‰è®°è½½</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œç‰¢è’‹è¿˜æé†’æˆ‘ä»¬å£°æ˜ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ¥æ ‡ç¤ºç°åœ¨æ­£åœ¨è¿è¡Œçš„åç¨‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">co</span> *<span class="title">curr_co</span> =</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>
<h5 id="åç¨‹çš„åˆ†é…ä¸é‡Šæ”¾">åç¨‹çš„åˆ†é…ä¸é‡Šæ”¾</h5>
<p>è¿™é‡Œå†™äº†ä¸¤ä¸ªå·¥å…·å‡½æ•° <code>co_alloc</code> å’Œ <code>co_free</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> co *<span class="title function_">co_alloc</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">void</span> (*func)(<span class="type">void</span> *), <span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">co</span> *<span class="title">new_co</span> =</span> (<span class="keyword">struct</span> co *)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> co));</span><br><span class="line">  new_co-&gt;name = (<span class="type">char</span> *)<span class="built_in">calloc</span>(<span class="built_in">strlen</span>(name) + <span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">  list_append_tail(&amp;coroutine_list, &amp;new_co-&gt;co_list);</span><br><span class="line">  new_co-&gt;status = CO_NEW; <span class="comment">/// every coroutine is CO_NEW at the beginning</span></span><br><span class="line">  new_co-&gt;waiter = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(new_co-&gt;name, name);</span><br><span class="line">  new_co-&gt;func = func;</span><br><span class="line">  new_co-&gt;arg = arg;</span><br><span class="line">  <span class="keyword">return</span> new_co;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">co_free</span><span class="params">(<span class="keyword">struct</span> co *co)</span> &#123;</span><br><span class="line">  list_remove(&amp;coroutine_list, &amp;co-&gt;co_list);</span><br><span class="line">  <span class="built_in">free</span>(co-&gt;name);</span><br><span class="line">  <span class="built_in">free</span>(co);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ç¨‹åºåˆå§‹åŒ–å’Œæ¸…ç†">ç¨‹åºåˆå§‹åŒ–å’Œæ¸…ç†</h5>
<p>è¿˜è®°å¾—ç‰¢è’‹çš„å°è´´å£«å—ï¼Ÿ<code>main()</code> ä¹Ÿæ˜¯ä¸ªåç¨‹ï¼è€Œä¸”é“¾è¡¨å¤´ <code>coroutine_list</code> ä¹Ÿéœ€è¦åˆå§‹åŒ–ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>__attribute__((constructor))</code> å’Œ <code>__attribute__((destructor))</code> æ¥å®ç°åˆå§‹åŒ–å’Œæ¸…ç†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((constructor)) <span class="type">void</span> <span class="title function_">co_start_main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">/// Initialize coroutine_list.</span></span><br><span class="line">  list_init(&amp;coroutine_list);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Create a coroutine for main.</span></span><br><span class="line">  assert(curr_co == <span class="literal">NULL</span>);</span><br><span class="line">  curr_co = co_start(<span class="string">&quot;main&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  curr_co-&gt;status = CO_RUNNABLE; <span class="comment">/// avoid CO_NEW</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((destructor)) <span class="type">void</span> <span class="title function_">co_free_main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">/// Reap all coroutines which still exist.</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">co</span> *<span class="title">co</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">co</span> *<span class="title">co_next</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">  list_for_each_entry_safe(co, co_next, &amp;coroutine_list, co_list) &#123;</span><br><span class="line">    co_free(co);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹æ–‡ä¼šè®²åˆ° <code>co_start()</code> å®é™…ä¸Šåªæ˜¯ <code>co_alloc()</code> çš„åŒ…è£…ã€‚ç„¶åè¿™é‡Œ main åç¨‹æ˜¾ç„¶å·²ç»åœ¨è·‘äº†ï¼Œæ‰€ä»¥çŠ¶æ€ä¸èƒ½æ˜¯ <code>CO_NEW</code>ã€‚</p>
<h3 id="co_start"><code>co_start()</code></h3>
<p>åç¨‹å¹¶ä¸æ˜¯åœ¨ <code>co_start()</code> å°±å¼€å§‹æ‰§è¡Œçš„ï¼Œæ‰€ä»¥åªè¦åˆ†é…ä¸€ä¸ªç©ºåç¨‹å°±è¡Œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> co *<span class="title function_">co_start</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">void</span> (*func)(<span class="type">void</span> *), <span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">co</span> *<span class="title">new_co</span> =</span> co_alloc(name, func, arg);</span><br><span class="line">  <span class="keyword">return</span> new_co;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="co_wait"><code>co_wait()</code></h3>
<p><code>co_wait()</code> ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±ä¸€ç›´ç­‰ï¼Œç­‰ä¸åˆ°å°± yieldï¼Œç­‰åˆ°äº†ä¹‹å free æ‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">co_wait</span><span class="params">(<span class="keyword">struct</span> co *co)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Set the status of current coroutine to CO_WAITING.</span></span><br><span class="line">  curr_co-&gt;status = CO_WAITING;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Set the waiter.</span></span><br><span class="line">  co-&gt;waiter = curr_co;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// When the coroutine we&#x27;re waiting for is not dead,</span></span><br><span class="line">  <span class="comment">/// switch to another coroutine.</span></span><br><span class="line">  <span class="keyword">while</span> (co-&gt;status != CO_DEAD) &#123;</span><br><span class="line">    co_yield();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// It&#x27;s dead, free it.</span></span><br><span class="line">  co_free(co);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="co_yield"><code>co_yield()</code></h3>
<p>è¿™é‡Œæ˜¯é‡å¤´æˆã€‚æˆ‘ä»¬éœ€è¦é€‰ä¸€ä¸ªèƒ½è·‘çš„åç¨‹ï¼Œç„¶åä¿å­˜/åˆ‡æ¢ä¸Šä¸‹æ–‡ã€‚åç¨‹çš„é€‰å–ã€åˆ‡æ¢çš„æ—¶æœºã€ä¿å­˜çš„æ–¹æ³•éƒ½éå¸¸é‡è¦ã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œç‰¢è’‹ä¹ŸæŒ‡å®šäº†åˆ‡æ¢ä¸Šä¸‹æ–‡çš„æ–¹æ³•ï¼š <code>setjmp()</code> / <code>longjmp()</code>ã€‚ä»–ç”šè‡³å‘Šè¯‰äº†æˆ‘ä»¬æ€ä¹ˆä½¿ç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">co_yield</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> val = setjmp(current-&gt;context);</span><br><span class="line">  <span class="keyword">if</span> (val == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// ?</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ?</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®©æˆ‘ä»¬æ€è€ƒä¸€ä¸‹ï¼šä¸€ä¸ªåç¨‹åˆ‡å‡ºå»äº†ä»¥åï¼Œåˆ«çš„åœ°æ–¹è°ƒç”¨ <code>longjmp()</code> ç»™åˆ‡å›æ¥äº†ï¼Œé‚£ä¹ˆåˆ‡å›æ¥çš„åœ°æ–¹åœ¨å“ªé‡Œï¼Ÿæ˜¾ç„¶å°±æ˜¯ <code>setjmp()</code> é‚£é‡Œã€‚åˆ‡å›æ¥äº†ä¹‹åå¹²ä»€ä¹ˆå‘¢ï¼Ÿé‚£è‚¯å®šæ˜¯ç»§ç»­æ‰§è¡Œå•Šï¼æ‰€ä»¥ else åˆ†æ”¯ç›´æ¥è¿”å›å°±è¡Œã€‚</p>
<p>é‚£ä¸Šé¢çš„åˆ†æ”¯å‘¢ï¼Ÿä¸Šé¢çš„åˆ†æ”¯æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>setjmp()</code> çš„æƒ…å†µï¼Œè¿™æ—¶å€™æˆ‘ä»¬åˆšä¿å­˜å¥½å½“å‰åç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œæ‰“ç®—åˆ‡å‡ºå»ã€‚äºæ˜¯ï¼Œ<code>co_yield()</code> å…·ä½“è¯¥å¹²ä»€ä¹ˆå·²ç»å¾ˆæ¸…æ¥šäº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">co_yield</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (setjmp(current-&gt;context) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/// é€‰åç¨‹ï¼</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// æ¢ä¸Šä¸‹æ–‡ï¼</span></span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="é€‰åç¨‹">é€‰åç¨‹</h4>
<p>å‰é¢è¯´è¿‡ï¼Œæˆ‘ä»¬ç”¨ä¸€ç§ä¸‘é™‹çš„æ–¹å¼å¤§è‡´å®ç°äº† LRU ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹æ€ä¹ˆé€‰ç½¢ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Find a coroutine to run.</span></span><br><span class="line"><span class="comment">/// Choose one with least called_cnt.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">co</span> <span class="title">volatile</span> *<span class="title">exec_co</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">co</span> *<span class="title">least_called_co</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">size_t</span> least_called_val = SIZE_MAX;</span><br><span class="line">list_for_each_entry(exec_co, &amp;coroutine_list, co_list) &#123;</span><br><span class="line">    <span class="keyword">if</span> (exec_co-&gt;status == CO_NEW</span><br><span class="line">        || exec_co-&gt;status == CO_RUNNABLE</span><br><span class="line">        || exec_co-&gt;status == CO_WAITING) &#123;</span><br><span class="line">        <span class="keyword">if</span> (least_called_val &gt; exec_co-&gt;call_cnt) &#123;</span><br><span class="line">            least_called_val = exec_co-&gt;call_cnt;</span><br><span class="line">            least_called_co = (<span class="keyword">struct</span> co *)exec_co;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exec_co = least_called_co;</span><br></pre></td></tr></table></figure>
<p>ä¸ºä»€ä¹ˆåŠ  volatile ï¼Ÿç•™ç»™è¯»è€…åšä¹ é¢˜ã€‚</p>
<h4 id="æ¢ä¸Šä¸‹æ–‡">æ¢ä¸Šä¸‹æ–‡</h4>
<p>é€‰å¥½åç¨‹ä¹‹åï¼Œæˆ‘ä»¬å¢åŠ è°ƒç”¨æ¬¡æ•° <code>call_cnt</code>ï¼Œç„¶åè¿›è¡Œåˆ‡æ¢å°±å¥½äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curr_co = (<span class="keyword">struct</span> co *)exec_co;</span><br><span class="line">exec_co-&gt;call_cnt++;</span><br><span class="line"><span class="keyword">switch</span> (exec_co-&gt;status) &#123;</span><br><span class="line"><span class="comment">/// CO_RUNNABLE and CO_WAITING</span></span><br><span class="line"><span class="comment">/// Context has already set. Just use longjmp().</span></span><br><span class="line"><span class="keyword">case</span> CO_RUNNABLE:</span><br><span class="line"><span class="keyword">case</span> CO_WAITING: &#123;</span><br><span class="line">  longjmp(((<span class="keyword">struct</span> co *)exec_co)-&gt;context, <span class="number">1</span>);</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">  perror(<span class="string">&quot;co_yield status&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ«æ€¥ï¼ä½ æ˜¯ä¸æ˜¯å¿˜å†™äº†ä»€ä¹ˆï¼Ÿæ˜¯çš„ï¼Œæˆ‘å¿˜å†™äº† <code>CO_NEW</code> ï¼å¦‚æœ <code>CO_NEW</code> ä¹Ÿç”¨ <code>longjmp()</code> è¡Œä¸è¡Œå‘¢ï¼Ÿ</p>
<p>ä½ ä¼šæ­»å¾—å¾ˆæƒ¨ï¼š</p>
<figure>
<img src="/2024/11/20/jyy-M2-libco/segfault.png" alt="" /><figcaption>segfault.png</figcaption>
</figure>
<p>è°ƒè¯•å‘ç°ï¼Œ <code>CO_NEW</code> çš„çº¿ç¨‹è¿˜æ²¡æœ‰å¯ç”¨çš„ä¸Šä¸‹æ–‡ï¼Œä½ åªèƒ½ç›´æ¥è·³è½¬è¿‡å»ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CO_NEW: &#123;</span><br><span class="line">  <span class="comment">/// Save context and jump there.</span></span><br><span class="line">  ((<span class="keyword">struct</span> co <span class="keyword">volatile</span> *)exec_co)-&gt;status = CO_RUNNABLE;</span><br><span class="line">  stack_switch_call(((<span class="keyword">struct</span> co *)exec_co)-&gt;<span class="built_in">stack</span> + STACK_SIZE, exec_co-&gt;func,</span><br><span class="line">                    (<span class="type">uintptr_t</span>)exec_co-&gt;arg);</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ª <code>stack_switch_call()</code> è¿›è¡Œäº†ä¸€ä¸ªæ¢æ ˆå’Œè·³è½¬çš„å·¥ä½œã€‚è¿™é‡Œç‰¢è’‹ç»™äº†ä¸€ä¸ªå‚è€ƒå®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">stack_switch_call</span><span class="params">(<span class="type">void</span> *sp, <span class="type">void</span> *entry, <span class="type">uintptr_t</span> arg)</span> &#123;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">#<span class="keyword">if</span> __x86_64__</span></span><br><span class="line"><span class="params">    <span class="string">&quot;movq %0, %%rsp; movq %2, %%rdi; jmp *%1&quot;</span></span></span><br><span class="line"><span class="params">      : : <span class="string">&quot;b&quot;</span>((<span class="type">uintptr_t</span>)sp), <span class="string">&quot;d&quot;</span>(entry), <span class="string">&quot;a&quot;</span>(arg) : <span class="string">&quot;memory&quot;</span></span></span><br><span class="line"><span class="params">#<span class="keyword">else</span></span></span><br><span class="line"><span class="params">    <span class="string">&quot;movl %0, %%esp; movl %2, 4(%0); jmp *%1&quot;</span></span></span><br><span class="line"><span class="params">      : : <span class="string">&quot;b&quot;</span>((<span class="type">uintptr_t</span>)sp - <span class="number">8</span>), <span class="string">&quot;d&quot;</span>(entry), <span class="string">&quot;a&quot;</span>(arg) : <span class="string">&quot;memory&quot;</span></span></span><br><span class="line"><span class="params">#endif</span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œç‰¢è’‹æ˜¾ç„¶æŒ–äº†ä¸€ä¸ªå°å‘ï¼šå¦‚æœç›´æ¥ jmp è¿‡å»çš„è¯æ€ä¹ˆè·³å›æ¥ï¼Ÿå› æ­¤ jmp æŒ‡ä»¤è¦æ”¹æˆ call æŒ‡ä»¤ã€‚</p>
<p>åˆ°äº†è¿™é‡Œï¼Œå¯ä»¥å›å»ç¡è§‰äº†ã€‚</p>
<h4 id="çœŸçš„å‡çš„">çœŸçš„å‡çš„ï¼Ÿ</h4>
<p>å¦‚æœä½ è¿™æ—¶å€™ä¸å·æ‡’è·‘ä¸€ä¸‹æµ‹è¯•ï¼Œä½ ä¼šå‘ç°æ®µé”™è¯¯äº†ï¼š</p>
<figure>
<img src="/2024/11/20/jyy-M2-libco/segfault2.png" alt="" /><figcaption>segfault2.png</figcaption>
</figure>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œä¸ä¹‹å‰çš„æ®µé”™è¯¯ç›¸æ¯”è¾ƒï¼Œæˆ‘ä»¬çš„åç¨‹æ˜¯è·‘å®Œä¹‹åæ‰å‡ºé—®é¢˜çš„ã€‚è®²åˆ°è¿™é‡Œï¼Œé¥±é¥±ä»¬æ˜¯ä¸æ˜¯å¾ˆå¥½å¥‡ï¼Œåç¨‹è·‘å®Œä¹‹åå»äº†å“ªé‡Œï¼Ÿ<del>å»ç”µå½±é™¢äº†</p>
<p>æˆ‘ä»¬ç”¨ gdb çœ‹ä¸€ä¸‹å»äº†å“ªé‡Œã€‚ç‰¢è’‹çš„æµ‹ä¾‹ 1 ä¸­åç¨‹çš„å…¥å£ç‚¹å« workï¼Œæˆ‘ä»¬åœ¨é‚£é‡Œæ‰“ä¸ªæ–­ç‚¹ï¼Œç„¶åä¸€ç›´ niã€‚</p>
<figure>
<img src="/2024/11/20/jyy-M2-libco/before_ret.png" alt="" /><figcaption>before_ret.png</figcaption>
</figure>
<figure>
<img src="/2024/11/20/jyy-M2-libco/after_ret.png" alt="" /><figcaption>after_ret.png</figcaption>
</figure>
<p>åœ¨ <code>work()</code> çš„ ret æŒ‡ä»¤è·‘å®Œè¿‡åï¼Œæˆ‘ä»¬å‘ç°å®ƒå›åˆ°äº† <code>co_yield()</code> ï¼ä¸Šé¢è¿™ä¸ª call æŒ‡ä»¤å“ªæ¥çš„ï¼Ÿæ³¨æ„åˆ°è¿™ä¸ª call è·³è½¬çš„ä¸æ˜¯ä¸€ä¸ªç»å¯¹åœ°å€ï¼Œå‰é¢æåˆ°è¿‡ï¼Œæˆ‘ä»¬éœ€è¦ <code>stack_switch_call()</code> è·³è½¬åˆ°é€‰å®šåç¨‹çš„å…¥å£ç‚¹ <code>func</code> ï¼Œè¿™å°±æ˜¯ call æŒ‡ä»¤çš„æ¥æºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¤§æ¦‚æ˜¯è·³è½¬åˆ°äº† <code>stack_switch_call()</code> åé¢ï¼Œç›¸å½“äº <code>CO_NEW</code> çŠ¶æ€çš„æ–°åç¨‹æ‰§è¡Œå®Œäº†ã€‚</p>
<p>çŸ¥é“äº†è·³è½¬åˆ°å“ªé‡Œï¼Œæˆ‘ä»¬å°±æ¯”è¾ƒå¥½è¿›è¡Œæ”¶å°¾å·¥ä½œäº†ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å°†åˆšè·‘å®Œçš„åç¨‹çš„çŠ¶æ€è®¾ç½®æˆ <code>CO_DEAD</code>ï¼Œç„¶åè®©å‡ºæ‰§è¡Œæƒã€‚è¿™é‡Œæˆ‘ç›´æ¥å°†æ‰§è¡Œæƒè®©ç»™äº†ç­‰å¾…å®ƒçš„åç¨‹ <code>waiter</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">stack_switch_call(((<span class="keyword">struct</span> co *)exec_co)-&gt;<span class="built_in">stack</span> + STACK_SIZE, exec_co-&gt;func,</span><br><span class="line">                    (<span class="type">uintptr_t</span>)exec_co-&gt;arg);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// When coroutine returns, %rip goes here.</span></span><br><span class="line"><span class="comment">/// Set status to CO_DEAD.</span></span><br><span class="line">exec_co-&gt;status = CO_DEAD;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Jump to the waiter.</span></span><br><span class="line">curr_co = exec_co-&gt;waiter;</span><br><span class="line">longjmp(exec_co-&gt;waiter-&gt;context, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šä¹Ÿæœ‰ç”¨ <code>co_yield()</code> å‡ºè®©æ‰§è¡Œæƒçš„å†™æ³•ã€‚</p>
<h4 id="stack_switch_call"><code>stack_switch_call()</code></h4>
<p>æ”¹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬é‡æ–°è·‘ä¸€ä¸‹ï¼Œå‘ç°è¿˜æ˜¯æ®µé”™è¯¯äº†ã€‚è°ƒè¯•å‘ç°ï¼Œ <code>exec_co</code> ä¸çŸ¥é“æŒ‡å‘å“ªé‡Œäº†ï¼š</p>
<figure>
<img src="/2024/11/20/jyy-M2-libco/exec_co.png" alt="" /><figcaption>exec_co.png</figcaption>
</figure>
<p>ä» <code>exec_co-&gt;status = CO_DEAD;</code> è¿™å¥å¯¹åº”çš„æ±‡ç¼–æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ª <code>exec_co</code> çš„å€¼å®é™…ä¸Šå°±æ˜¯ rcx å¯„å­˜å™¨çš„ã€‚è¿™è¯´æ˜ä»è°ƒç”¨ <code>stack_switch_call()</code> åˆ°è¿”å›è¿™æ®µæ—¶é—´ï¼Œæˆ‘ä»¬çš„ rcx å¯„å­˜å™¨è¢«æ”¹å˜äº†ã€‚ä¸€ä¸ªæœ´ç´ çš„æƒ³æ³•æ˜¯è°ƒç”¨å‰ä¿å­˜ rcx å¯„å­˜å™¨çš„å€¼ï¼Œè°ƒç”¨è¿‡åæ¢å¤ã€‚äºæ˜¯æˆ‘ä»¬å¾ˆå®¹æ˜“å¯¹ <code>stack_switch_call()</code> ä½œå¦‚ä¸‹ä¿®æ”¹ï¼ˆå…ˆä¸ç®¡ 32 ä½ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">stack_switch_call</span><span class="params">(<span class="type">void</span> *sp, <span class="type">void</span> *entry, <span class="type">uintptr_t</span> arg)</span> &#123;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="string">&quot;movq %0, %%rsp;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%rcx;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;movq %2, %%rdi;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;call *%1\n\t&quot;</span></span></span><br><span class="line"><span class="params">      :</span></span><br><span class="line"><span class="params">      : <span class="string">&quot;b&quot;</span>((<span class="type">uintptr_t</span>)sp), <span class="string">&quot;d&quot;</span>(entry), <span class="string">&quot;a&quot;</span>(arg)</span></span><br><span class="line"><span class="params">      : <span class="string">&quot;memory&quot;</span></span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¿˜å¯ä»¥å†™å‡ºæ¢å¤å‡½æ•° <code>restore_return()</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">restore_return</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%rcx;&quot;</span></span></span><br><span class="line"><span class="params">      :</span></span><br><span class="line"><span class="params">      :</span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜è®°å¾—å¯¹é½è¦æ±‚å—ï¼Ÿä½ å¯ä»¥è‡ªå·±æ”¹æ”¹ã€‚</p>
<p>ä½ å¯èƒ½å¥½å¥‡è¿™ä¸ª rcx æ˜¯æ€ä¹ˆæ¥çš„ï¼Œä¸‡ä¸€ç¼–è¯‘å™¨é€‰æ‹©äº†å…¶ä»–å¯„å­˜å™¨ï¼ˆæ¯”å¦‚ rdxï¼‰æ€ä¹ˆåŠï¼Ÿä½ ä¹Ÿè®¸èƒ½æƒ³èµ·æ¥æœ‰ä¸ªä¸œè¥¿å« calling convention<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>ï¼š</p>
<blockquote>
<ol type="1">
<li><p>Before calling a subroutine, the caller should save the contents of certain registers that are designated caller-saved. The caller-saved registers are r10, r11, and any registers that parameters are put into. If you want the contents of these registers to be preserved across the subroutine call, push them onto the stack.</p></li>
<li><p>To pass parameters to the subroutine, we put up to six of them into registers (in order: rdi, rsi, rdx, rcx, r8, r9).</p></li>
</ol>
</blockquote>
<p>è¿™è¯´æ˜æˆ‘ä»¬ä½œä¸º caller éœ€è¦ä¿å­˜ä¸Šé¢è¯´çš„å¯„å­˜å™¨ã€‚æ ¹æ® calling convention çš„æ”¹å†™å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Save the current context to the coroutine&#x27;s stack and call it.</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">stack_switch_call</span><span class="params">(<span class="type">void</span> *sp, <span class="type">void</span> *entry, <span class="type">uintptr_t</span> arg)</span> &#123;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="string">&quot;movq %0, %%rsp;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%r11;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%r10;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%r9;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%r8;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%rcx;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%rdx;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%rsi;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%rdi;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%rax;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;subq $8, %%rsp;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;movq %2, %%rdi;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;call *%1\n\t&quot;</span></span></span><br><span class="line"><span class="params">      :</span></span><br><span class="line"><span class="params">      : <span class="string">&quot;b&quot;</span>((<span class="type">uintptr_t</span>)sp), <span class="string">&quot;d&quot;</span>(entry), <span class="string">&quot;a&quot;</span>(arg)</span></span><br><span class="line"><span class="params">      : <span class="string">&quot;memory&quot;</span></span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Recover context from the coroutine&#x27;s stack.</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">restore_return</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="string">&quot;addq $8, %%rsp;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%rax;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%rdi;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%rsi;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%rdx;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%rcx;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%r8;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%r9;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%r10;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%r11;&quot;</span></span></span><br><span class="line"><span class="params">      :</span></span><br><span class="line"><span class="params">      :</span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>32 ä½çš„ç‰ˆæœ¬ä¾è‘«èŠ¦ç”»ç“¢å°±è¡Œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Save the current context to the coroutine&#x27;s stack and call it.</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">stack_switch_call</span><span class="params">(<span class="type">void</span> *sp, <span class="type">void</span> *entry, <span class="type">uintptr_t</span> arg)</span> &#123;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="string">&quot;movl %0, %%esp;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%edx;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%ecx;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%eax;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;call *%1;&quot;</span></span></span><br><span class="line"><span class="params">      :</span></span><br><span class="line"><span class="params">      : <span class="string">&quot;b&quot;</span>((<span class="type">uintptr_t</span>)sp), <span class="string">&quot;d&quot;</span>(entry), <span class="string">&quot;a&quot;</span>(arg)</span></span><br><span class="line"><span class="params">      : <span class="string">&quot;memory&quot;</span></span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Recover context from the coroutine&#x27;s stack.</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">restore_return</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%eax;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%ecx;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%edx;&quot;</span></span></span><br><span class="line"><span class="params">      :</span></span><br><span class="line"><span class="params">      :</span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ä¸€äº›å°é—®é¢˜">ä¸€äº›å°é—®é¢˜</h4>
<p>æ”¹åˆ°è¿™é‡Œï¼Œ64 ä½çš„æµ‹è¯•åŸºæœ¬ä¸Šèƒ½è·‘èµ·æ¥äº†ï¼Œä½†æ˜¯ 32 ä½çš„è¿˜æ˜¯ä¼šæ®µé”™è¯¯ï¼Œå‡ºé”™çš„åœ°æ–¹åœ¨è¿™é‡Œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CO_NEW: &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  curr_co = exec_co-&gt;waiter; <span class="comment">/// SEGFAULT!!!</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹å¯¹åº”æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1484:	8b 51 14             	mov    0x14(%ecx),%edx</span><br><span class="line">1487:	8b 5c 24 0c          	mov    0xc(%esp),%ebx</span><br><span class="line">148b:	8b 83 ec ff ff ff    	mov    -0x14(%ebx),%eax</span><br><span class="line">1491:	89 10                	mov    %edx,(%eax)</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ <code>0xc(%esp)</code> å°±æ˜¯ <code>curr_co</code> ï¼Œä½†æ˜¯æˆ‘çš„ <code>curr_co</code> æ˜æ˜æ˜¯å…¨å±€å˜é‡å•Šä¸ºä»€ä¹ˆè¦ç›¸å¯¹ esp å¯»å€ï¼Ÿ</p>
<p>è¿™å°±æ¶‰åŠåˆ° x86 çš„ä¸€ä¸ªç»†èŠ‚ï¼šåœ¨ä½ç½®æ— å…³ä»£ç é‡Œé¢ï¼Œå…¨å±€å˜é‡åœ°å€éœ€è¦å…ˆé€šè¿‡ <code>__x86.get_pc_thunk</code> æ”¾åˆ°æŸä¸ªå¯„å­˜å™¨ï¼Œå†ä»è¿™ä¸ªå¯„å­˜å™¨æ”¾åˆ°æ ˆä¸Š<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>ã€‚å†çœ‹çœ‹ä¹‹å‰çš„å®ç°ï¼Œ esp å¯„å­˜å™¨æ˜¾ç„¶è¿˜æŒ‡å‘åˆšè·‘å®Œåç¨‹çš„æ ˆç©ºé—´ï¼Œè¿™å°±ä¼šå‡ºé—®é¢˜ã€‚æœ‰ä¸€ä¸ªæœ´ç´ çš„è§£å†³æ–¹æ³•ï¼šä¿å­˜ä¸Šä¸‹æ–‡çš„æ—¶å€™ä¸€å¹¶ä¿å­˜ esp ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">stack_switch_call</span><span class="params">(<span class="type">void</span> *sp, <span class="type">void</span> *entry, <span class="type">uintptr_t</span> arg)</span> &#123;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="string">&quot;movl %%esp, -8(%0);&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;movl %0, %%esp;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;subl $8, %%esp;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%edx;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%ecx;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %%eax;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;push %2;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;call *%1;&quot;</span></span></span><br><span class="line"><span class="params">      :</span></span><br><span class="line"><span class="params">      : <span class="string">&quot;b&quot;</span>((<span class="type">uintptr_t</span>)sp), <span class="string">&quot;d&quot;</span>(entry), <span class="string">&quot;a&quot;</span>(arg)</span></span><br><span class="line"><span class="params">      : <span class="string">&quot;memory&quot;</span></span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">restore_return</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="string">&quot;addl $4, %%esp;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%eax;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%ecx;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%edx;&quot;</span></span></span><br><span class="line"><span class="params">      <span class="string">&quot;pop %%esp;&quot;</span></span></span><br><span class="line"><span class="params">      :</span></span><br><span class="line"><span class="params">      :</span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸è¿‡å¦‚æœå‡ºè®©æ‰§è¡Œæƒä½¿ç”¨çš„æ˜¯ <code>co_yield()</code> è€Œä¸æ˜¯ longjmp åˆ° waiterï¼Œå¥½åƒå°±ä¸ç”¨é¢å¯¹è¿™ä¸ªé—®é¢˜ï¼ˆ</p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p><a target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2022/labs/M2.html">https://jyywiki.cn/OS/2022/labs/M2.html</a><a href="#fnref1" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn2" role="doc-endnote"><p><a target="_blank" rel="noopener" href="https://aaronbloomfield.github.io/pdr/book/x86-64bit-ccc-chapter.pdf">https://aaronbloomfield.github.io/pdr/book/x86-64bit-ccc-chapter.pdf</a><a href="#fnref2" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn3" role="doc-endnote"><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6679846/what-is-i686-get-pc-thunk-bx-why-do-we-need-this-call">https://stackoverflow.com/questions/6679846/what-is-i686-get-pc-thunk-bx-why-do-we-need-this-call</a><a href="#fnref3" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
</ol>
</section>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>asterich
  </li>
  <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://asterich.top/2024/11/20/jyy-M2-libco/" title="NJU OS Lab M2: libco">https://asterich.top/2024/11/20/jyy-M2-libco/</a>
  </li>
  <li class="post-copyright-license">
      <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/C/" rel="tag"># C</a>
              <a href="/tags/Assembly/" rel="tag"># Assembly</a>
              <a href="/tags/sys/" rel="tag"># sys</a>
              <a href="/tags/Coroutine/" rel="tag"># Coroutine</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/11/20/%E4%BF%9D%E7%A0%94%E5%A4%8F%E4%BB%A4%E8%90%A5/" rel="prev" title="ä¿ç ”å¤ä»¤è¥">
                  <i class="fa fa-angle-left"></i> ä¿ç ”å¤ä»¤è¥
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">asterich</span>
  </div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"asterich/asterich_blog_comment","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
